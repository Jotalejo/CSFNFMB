{% extends "layout.html" %}
{% block content %}
<div class="section-body">
    <div class="container-fluid">
        <div class="row clearfix">
            <div class="col-md-12">
                <div class="card">
                    <!-- start body header -->
                    <div class="section-body">
                        <div class="container-fluid">
                            <div class="page-header">
                                <div class="left">
                                    <h1 class="page-title">Administración de Residuos del Cliente</h1>
                                </div>                    
                            </div></br>
                            <div class="row">
                                <div class="col-md-12">
                                    <form class="card" id="frecuenciaForm" method="{{ "PATCH" if (frecuencia and frecuencia.id > 0) else "POST" }}" action="/frecuencia/">
                                        <div class="card-body">
                                            <h3 class="card-title">Frecuencia de recolección</h3>
                                            
                                            <!-- ID del cliente -->
                                            <input type="hidden" name="cliente_id" id="cliente_id" value="{{ cliente_id }}"/>
                                            <input type="hidden" name="frecuencia_id" id="frecuencia_id" value="{{ frecuencia.id if frecuencia else '' }}"/>

                                            <!-- tipo_nombre -->
                                            <div class="form-group col-lg-4 col-md-12">
                                                <label>Tipo de frecuencia</label>
                                                <div class="custom-controls-stacked">
                                                    <label class="custom-control custom-radio">
                                                        <input type="radio" name="tipo_nombre" value="diaria" class="custom-control-input" {{ 'checked' if frecuencia and frecuencia.tipo_id == 1 else '' }}>
                                                        <span class="custom-control-label">Diaria</span>
                                                    </label>
                                                    <label class="custom-control custom-radio">
                                                        <input type="radio" name="tipo_nombre" value="semanal" class="custom-control-input" {{ 'checked' if frecuencia and frecuencia.tipo_id == 2 else '' }}>
                                                        <span class="custom-control-label">Semanal</span>
                                                    </label>
                                                    <label class="custom-control custom-radio">
                                                        <input type="radio" name="tipo_nombre" value="mensual" class="custom-control-input" {{ 'checked' if frecuencia and frecuencia.tipo_id == 3 else '' }}>
                                                        <span class="custom-control-label">Mensual</span>
                                                    </label>
                                                </div>
                                            </div>

                                            <!-- semanal -->
                                            <div class="form-group col-lg-4 col-md-12 freq-semanal d-none">
                                                <label>Días de la semana</label>
                                                <div class="custom-controls-stacked">
                                                    <label class="custom-control custom-checkbox"><input type="checkbox" value="1" class="custom-control-input dow" {{ 'checked' if (dias_semana and dias_semana[1]) else '' }} ><span class="custom-control-label">Lunes</span></label>
                                                    <label class="custom-control custom-checkbox"><input type="checkbox" value="2" class="custom-control-input dow" {{ 'checked' if (dias_semana and dias_semana[2]) else '' }} ><span class="custom-control-label">Martes</span></label>
                                                    <label class="custom-control custom-checkbox"><input type="checkbox" value="3" class="custom-control-input dow" {{ 'checked' if (dias_semana and dias_semana[3]) else '' }} ><span class="custom-control-label">Miércoles</span></label>
                                                    <label class="custom-control custom-checkbox"><input type="checkbox" value="4" class="custom-control-input dow" {{ 'checked' if (dias_semana and dias_semana[4]) else '' }} ><span class="custom-control-label">Jueves</span></label>
                                                    <label class="custom-control custom-checkbox"><input type="checkbox" value="5" class="custom-control-input dow" {{ 'checked' if (dias_semana and dias_semana[5]) else '' }} ><span class="custom-control-label">Viernes</span></label>
                                                    <label class="custom-control custom-checkbox"><input type="checkbox" value="6" class="custom-control-input dow" {{ 'checked' if (dias_semana and dias_semana[6]) else '' }} ><span class="custom-control-label">Sábado</span></label>
                                                    <label class="custom-control custom-checkbox"><input type="checkbox" value="0" class="custom-control-input dow" {{ 'checked' if (dias_semana and dias_semana[0]) else '' }} ><span class="custom-control-label">Domingo</span></label>
                                                </div>
                                                <small class="text-muted">Selecciona los días en que pasas.</small>
                                            </div>

                                            <!-- mensual -->
                                            <div class="form-group col-lg-4 col-md-12 freq-mensual d-none">
                                                <label>Días del mes</label>
                                                <input type="text" id="dom_list" class="form-control" placeholder="Ej: 1, 10, 20, 30" value="{{ frecuencia.dias_mes if frecuencia and frecuencia.dias_mes else '' }}">
                                                <small class="text-muted">Lista separada por comas (1-31).</small>
                                            </div>

                                            <!-- horas -->
                                            <div class="form-group col-lg-4 col-md-12">
                                                <label>Hora preferida</label>
                                                <input type="time" id="hora_pref" class="form-control" step="60" value="{{ (frecuencia.hora_desde if frecuencia and frecuencia.hora_desde else '08:00') }}">

                                                <div class="mt-2 font-weight-bold">Horario opcional (rango)</div>
                                                <small class="text-muted d-block">Si no defines un rango, se usará solo la hora preferida.</small>

                                                <div class="form-row mt-1">
                                                    <div class="col">
                                                        <input type="time" id="ventana_ini" class="form-control" placeholder="Desde (HH:MM)" value="{{ (frecuencia.hora_desde|string)[:5] if frecuencia and frecuencia.hora_desde else '' }}">
                                                        <div class="invalid-feedback" id="err_ini"></div>
                                                    </div>
                                                    <div class="col">
                                                        <input type="time" id="ventana_fin" class="form-control" placeholder="Hasta (HH:MM)" value="{{ (frecuencia.hora_hasta|string)[:5] if frecuencia and frecuencia.hora_hasta else '' }}">
                                                        <div class="invalid-feedback" id="err_fin"></div>
                                                    </div>
                                                </div>
                                                <small class="text-muted">Ejemplo: 08:00 a 10:00</small>
                                            </div>

                                            <div class="form-group col-lg-4 col-md-12">
                                                <label>Veces por semana/mes</label>
                                                <input type="number" id="veces" class="form-control" min="1" max="30" value="{{frecuencia.veces or 1}}">
                                                <small class="text-muted">Interpreta según el tipo (semanal/mensual).</small>
                                            </div>

                                            <div class="form-group col-lg-4 col-md-12">
                                                <label>Capacidad estimada por visita (Kg)</label>
                                                <input type="number" id="cap_estimada" class="form-control" min="1" max="100000" step="1" required value="{{frecuencia.capacidad_kg or ''}}">
                                            </div>

                                            <div class="form-group col-lg-8 col-md-12">
                                                <label>Observaciones</label>
                                                <textarea id="observ" class="form-control" rows="2" placeholder="Opcional">{{ frecuencia.observ if frecuencia and frecuencia.observ else '' }}</textarea>
                                            </div>

                                            <input type="hidden" class="custom-control-input" id="activo" checked>
                                            <div class="form-group col-12">
                                                <button id="btnSaveResiduos" type="submit" class="btn btn-primary">Guardar</button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            </div></br>
                        </div>
                    </div>  
                </div>
            </div>
        </div>  
    </div>
</div>

{% endblock %}

{% block scripts %}

<script>
  function valById(id) {
  // funciona si hay jQuery o no
  const el = document.getElementById(id);
  if (!el) return '';
  // si jQuery está presente y el elemento también es alcanzable por él:
  if (window.jQuery) {
    const $el = window.jQuery('#' + id);
    if ($el.length) return ($el.val() ?? '').toString();
  }
  return (el.value ?? '').toString();
}

async function cargarTiposResiduo(selectedId) {
  try {
    const res = await fetch('/tiposresid/options');
    const options = await res.json(); // [{id, text}]
    const sel = document.getElementById('tresiduo');
    sel.innerHTML = '<option label="Escoja el Tipo de Residuo ..." disabled></option>';

    options.forEach(opt => {
      const o = document.createElement('option');
      o.value = opt.id;
      o.textContent = opt.text || '';
      if (selectedId && Number(selectedId) === Number(opt.id)) o.selected = true;
      sel.appendChild(o);
    });

    // Selecciona cabecera como disabled si no hay selectedId
    if (!selectedId) sel.selectedIndex = 0;
  } catch (e) {
    console.error('Error cargando tipos de residuo', e);
    alert('No se pudo cargar la lista de tipos de residuo.');
  }
}
</script>

<script>
    $(document).ready(function() {
        $('#btnSaveResiduos').on('click', function() {
            // Validar el formulario antes de enviar
            if ($('#frecuenciaForm')[0].checkValidity()) {
                // Si es válido, enviar el formulario
                
                send_form('frecuenciaForm');
                $('#btnDismiss').click(); // Cerrar el modal después de enviar
                
            } else {
                // Si no es válido, mostrar un mensaje de error
                alert("Por favor, completa todos los campos requeridos.");
            }
        });
    });
</script>

<script>
(function(){
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => Array.from(document.querySelectorAll(sel));

  function tipoSeleccionado(){
    return document.querySelector('input[name="tipo_nombre"]:checked')?.value || 'diaria';
  }

  function togglePanels(){
    const t = tipoSeleccionado();
    $('.freq-semanal')?.classList.toggle('d-none', t !== 'semanal');
    $('.freq-mensual')?.classList.toggle('d-none', t !== 'mensual');
  }

  // Eventos de cambio para radios
  $$('#frecuenciaForm input[name="tipo_nombre"]').forEach(r => {
    r.addEventListener('change', togglePanels);
  });
  
  // Ejecutar togglePanels cuando el DOM esté listo y después de un pequeño delay
  // para asegurar que los valores del servidor ya están aplicados
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(togglePanels, 10);
    });
  } else {
    setTimeout(togglePanels, 10);
  }

  function parseDiasMesToString(txt){
    // Convierte "1, 10, 20" -> "1,10,20" validando 1..31
    if(!txt) return null;
    const arr = txt.split(',')
      .map(s => parseInt(s.trim(),10))
      .filter(n => !isNaN(n) && n>=1 && n<=31);
    return arr.length ? arr.join(',') : null;
  }

  function getDiasSemana(){
    // Tus checkboxes tienen valores 1..6 y 0 (domingo). El backend espera 1..7 (L..D)
    const vals = $$('.dow:checked').map(cb => parseInt(cb.value,10));
    return vals.map(v => v === 0 ? 7 : v); // 0 -> 7
  }

  async function onSubmitFrecuencia(e){
    e.preventDefault();

    const API_BASE = ''; // sin prefijo /app

    const cliente_id = parseInt(valById('cliente_id') || '0', 10);
    if(!cliente_id){
      alert('Cliente no válido (cliente_id vacío).');
      console.error('cliente_id no encontrado. ¿Existe <input type="hidden" id="cliente_id" value="..."> en el modal?');
      return;
    }

    const tipo_nombre = tipoSeleccionado();
    const veces = parseInt(valById('veces') || '1', 10);
    const capacidad_kg = (valById('cap_estimada') || '').trim();
    const observ = (valById('observ') || '').trim();
    const activo = document.getElementById('activo')?.checked ?? true;

    // Validación y decisión de horario opcional
    const rango = validarHorarioOpcional();
    if (!rango.ok) return;

    const hora_pref = valById('hora_pref') || null;
    const hora_desde = rango.ini || hora_pref || null;
    const hora_hasta = rango.fin || null;

    // Validaciones por tipo
    let dias_semana = null;
    let dias_mes = null;
    if (tipo_nombre === 'semanal'){
      const ds = getDiasSemana();
      if (!ds.length){ alert('Selecciona al menos un día de la semana.'); return; }
      dias_semana = ds;
    } else if (tipo_nombre === 'mensual'){
      dias_mes = parseDiasMesToString(valById('dom_list') || '');
      if (!dias_mes){ alert('Indica al menos un día del mes (1-31).'); return; }
    }

    const capInt = capacidad_kg ? parseInt(capacidad_kg, 10) : null;

    const payload = {
      cliente_id,
      tipo_nombre,
      dias_semana,
      dias_mes,
      hora_desde,
      hora_hasta,
      veces: isNaN(veces) ? null : veces,
      capacidad_kg: capInt,
      observ: observ || null,
      activo
    };

    

    console.log('POST payload /app/frecuencias/:', payload); // <-- LOG ÚTIL

    try{
      frecuencia_id = parseInt(valById('frecuencia_id') || '0', 10);
      method = frecuencia_id > 0 ? 'PATCH' : 'POST';
      if (method === 'PATCH'){
        payload.frecuencia_id = parseInt(valById('frecuencia_id') || '0', 10);
      }

      const res = await fetch(`${API_BASE}/frecuencias/`, {
        method: method,
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });

      // Muestra el status real (si fuera 422, 400, etc.)
      console.log('Respuesta create frecuencia:', res.status, res.statusText);

      const maybeJson = await res.json().catch(() => null);
      if(!res.ok){
        throw new Error((maybeJson && (maybeJson.detail || JSON.stringify(maybeJson))) || res.statusText || 'Error al guardar');
      }

      const data = maybeJson; // FrecuenciaOut
      alert('Frecuencia guardada con éxito (ID: ' + data.id + ').');

      // si quieres: cerrar modal y refrescar tabla
      // $('#MdlFrecuenciaCliente').modal('hide');
      // cargarFrecuencias(cliente_id);

    }catch(err){
      console.error('Error POST /app/frecuencias/:', err);
      alert('No se pudo guardar: ' + err.message);
    }
  }

  // Enganchar submit del form
  const form = $('#frecuenciaForm');
  if (form){
    form.addEventListener('submit', onSubmitFrecuencia);
  }
})();
</script>

<script>
(function(){

  $("#frecuenciaForm").on('submit', function () {
    
    return false; // Evita el submit normal
  });

  // Helpers para setear valores
  function setVal(sel, val){
    const el = document.querySelector(sel);
    if(!el) return;
    el.value = (val ?? '').toString();
    el.dispatchEvent(new Event('input', {bubbles:true}));
  }
  function setRadio(name, value){
    const els = document.querySelectorAll(`input[name="${name}"]`);
    els.forEach(r => { r.checked = (r.value === value); });
  }
  function setChecks(selector, values){
    const set = new Set((values||[]).map(v => String(v)));
    document.querySelectorAll(selector).forEach(cb => {
      cb.checked = set.has(String(cb.value));
    });
  }

  // Esta función precarga desde el backend
  window.precargarFrecuencia = async function(clienteId){
    try{
      const r = await fetch(`/residuoscli/cliente/${clienteId}`, { headers: {'Accept':'application/json'} });
      if(!r.ok) throw new Error('No se pudo obtener configuración');
      const j = await r.json();
      const cfg = j.configuracion || {};

      // tipo: diaria|semanal|mensual
      setRadio('freq_tipo', cfg.tipo || 'diaria');

      // Mostrar/ocultar paneles según tipo (reusa tu función)
      if (typeof window.togglePanels === 'function') {
        window.togglePanels();
      } else {
        // fallback sencillo:
        const $semanal = document.querySelector('.freq-semanal');
        const $mensual = document.querySelector('.freq-mensual');
        const t = cfg.tipo || 'diaria';
        if ($semanal) $semanal.classList.toggle('d-none', t !== 'semanal');
        if ($mensual) $mensual.classList.toggle('d-none', t !== 'mensual');
      }

      // Semanal
      setChecks('.dow', cfg.dias_semana || []);

      // Mensual (muestra texto separado por comas)
      setVal('#dom_list', (cfg.dias_mes||[]).join(', '));

      // Horas / ventana
      setVal('#hora_pref', cfg.hora_pref || '08:00');
      setVal('#ventana_ini', cfg.ventana_ini || '');
      setVal('#ventana_fin', cfg.ventana_fin || '');

      // Veces / capacidad
      setVal('#veces', cfg.veces ?? 1);
      setVal('#cap_estimada', cfg.cap_estimada ?? '');

    }catch(err){
      console.error(err);
      // Si falla, deja defaults
      setRadio('freq_tipo', 'diaria');
      if (typeof window.togglePanels === 'function') window.togglePanels();
    }
  };

})();
</script>

<script>
/* ==== Helpers de tiempo ==== */
function toMinutes(hhmm) {
  // "HH:MM" -> total minutos desde 00:00. Devuelve NaN si inválido.
  if (!hhmm || !/^\d{2}:\d{2}$/.test(hhmm)) return NaN;
  const [h, m] = hhmm.split(':').map(Number);
  if (h < 0 || h > 23 || m < 0 || m > 59) return NaN;
  return h * 60 + m;
}

function setInvalid(inputEl, msg) {
  if (!inputEl) return;
  inputEl.classList.add('is-invalid');
  const fb = inputEl.parentElement?.querySelector('.invalid-feedback');
  if (fb) fb.textContent = msg || '';
}

function clearInvalid(inputEl) {
  if (!inputEl) return;
  inputEl.classList.remove('is-invalid');
  const fb = inputEl.parentElement?.querySelector('.invalid-feedback');
  if (fb) fb.textContent = '';
}

/* ==== Validación del rango opcional ==== */
/**
 * Valida el "Horario opcional (rango)".
 * Reglas:
 *  - Si uno está lleno, el otro también.
 *  - fin > ini.
 *  - (Opcional) hora_pref dentro del rango (solo warning en consola).
 * Devuelve: { ok:boolean, ini:string|null, fin:string|null }
 */
function validarHorarioOpcional() {
  const iniEl = document.getElementById('ventana_ini');
  const finEl = document.getElementById('ventana_fin');
  const prefEl = document.getElementById('hora_pref');

  const ini = (iniEl?.value || '').trim();
  const fin = (finEl?.value || '').trim();
  const pref = (prefEl?.value || '').trim();

  // Limpia estados
  clearInvalid(iniEl);
  clearInvalid(finEl);

  // Caso: ninguno -> válido, sin rango
  if (!ini && !fin) {
    return { ok: true, ini: null, fin: null };
  }

  // Caso: uno sí y otro no -> error
  if (!ini || !fin) {
    if (!ini) setInvalid(iniEl, 'Falta la hora de inicio');
    if (!fin) setInvalid(finEl, 'Falta la hora de fin');
    return { ok: false, ini: null, fin: null };
  }

  // Formato válido
  const mi = toMinutes(ini);
  const mf = toMinutes(fin);
  if (Number.isNaN(mi)) {
    setInvalid(iniEl, 'Formato inválido (usa HH:MM)');
    return { ok: false, ini: null, fin: null };
  }
  if (Number.isNaN(mf)) {
    setInvalid(finEl, 'Formato inválido (usa HH:MM)');
    return { ok: false, ini: null, fin: null };
  }

  // Orden: fin > ini
  if (mf <= mi) {
    setInvalid(finEl, 'La hora de fin debe ser mayor que la de inicio');
    return { ok: false, ini: null, fin: null };
  }

  // (Opcional) advertencia si hora preferida está fuera del rango
  const mp = toMinutes(pref);
  if (!Number.isNaN(mp) && (mp < mi || mp > mf)) {
    // Solo aviso en consola; si quieres, muestra un toast/alert.
    console.warn('Hora preferida fuera del rango opcional');
  }

  return { ok: true, ini, fin };
}
</script>

<script>
function activarModal2(id) {
  const $modal = $('#MdlGestRescli');

  // Opcional: loader rápido
  $modal.html(
    '<div class="modal-dialog" role="document">' +
      '<div class="modal-content">' +
        '<div class="modal-body text-center p-5">' +
          '<div class="spinner-border" role="status"></div>' +
          '<div class="mt-2">Cargando…</div>' +
        '</div>' +
      '</div>' +
    '</div>'
  );

  // Cargar contenido del modal desde tu endpoint
  fetch('/residuoscli/cliente/' + id)
    .then(r => {
      if (!r.ok) throw new Error('Error al cargar el modal');
      return r.text();
    })
    .then(html => {
      // Insertar el HTML del modal
      $modal.html(html);

      // ⚠️ Si tu modal NUEVO no tiene #residuoForm, NO intentes engancharlo.
      const rform = document.getElementById('residuoForm');
      if (rform && typeof send_json === 'function') {
        rform.addEventListener('submit', send_json);
      }

      // SUGERENCIA: pasa el cliente_id como data-atributo para tu JS de frecuencia
      // <div id="MdlGestRescli" class="modal fade" data-cliente-id="{{ id }}">
      $modal.attr('data-cliente-id', id);

      // Mostrar modal
      $modal.modal('show');

      // Si tienes precarga de frecuencia:
      if (typeof precargarFrecuencia === 'function') {
        precargarFrecuencia(id);
      }
    })
    .catch(err => {
      console.error(err);
      alert('No se pudo abrir el modal');
    });
}

</script>
{% endblock %}