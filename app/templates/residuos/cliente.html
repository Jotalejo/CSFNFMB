<div class="modal-dialog" role="document">
    <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title" id="ModalResiduos">Administración de Residuos del Cliente</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        <div class="modal-body">
            <!-- Start main html -->
            <div id="main_content">
                <!-- start main body part-->
                <div>
                    <!-- start body header -->
                    <div id="page_top" class="section-body">
                        <div class="container-fluid">
                            <div class="page-header">
                                <div class="left">
                                    <h1 class="page-title">Manejo Residuos del Cliente</h1>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="section-body">
                        <div class="container-fluid">
                            <!-- Multi Select -->
                            <div class="row clearfix">
                                <div class="col-md-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h3 class="card-title">Selección de Tipos y Cantidad de Residuos Generados</h3><br>
                                        </div>
                                        <div class="card-body demo-card">
                                            <form id="residuoForm" method="post" action="/residuoscli/" data-redirect="{{url_redirect}}">
                                                        <!-- Campos del formulario -->
                                                        <input type="hidden" name="codcli" value="{{cliente_id}}">
                                                        <div class="form-group">
                                                            <label for="tresiduo">Tipo de Residuo</label>
                                                            <select id="tresiduo" name="tresiduo" class="form-control" required>
                                                                <option label="Escoja el Tipo de Residuo ..." selected disabled></option>
                                                                {% for tipores in tresiduos %}
                                                                    <option value="{{ tipores.id }}"
                                                                    {% if residuo and residuo.tresiduo == tipores.id %}selected{% endif %}>
                                                                    {{ tipores.nombre }}
                                                                    </option>
                                                                {% endfor %}
                                                            </select>
                                                        </div>
                                                        <div class="form-group">
                                                            <label for="cantresiduo">Cantidad</label>
                                                            <input type="number" step="0.01" class="form-control"
                                                                id="cantresiduo" name="cantresiduo" required>
                                                        </div>
                                                        <div class="form-group">
                                                            <label for="pesopromres">Peso Promedio</label>
                                                            <input type="number" step="0.01" class="form-control"
                                                                id="pesopromres" name="pesopromres" required>
                                                        </div>
                                                        <div class="form-group">
                                                            <label for="segregares">Segregación</label>
                                                            <input type="text" class="form-control" id="segregares"
                                                                name="segregares">
                                                        </div>
                                                        <div class="form-group">
                                                            <label for="numbolsas">Número de Bolsas</label>
                                                            <input type="number" class="form-control" id="numbolsas"
                                                                name="numbolsas">
                                                        </div>
                                                        <div class="form-group">
                                                            <label for="observaciones">Observaciones</label>
                                                            <textarea class="form-control" id="observaciones"
                                                                name="observaciones"></textarea>
                                                        </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button id="btnDismiss" type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
            <button id="btnSaveResiduos" type="button" class="btn btn-primary" onclick="">Guardar</button>
        </div>
    </div>
</div>

<script>
async function cargarTiposResiduo(selectedId) {
  try {
    const res = await fetch('/tiposresid/options');
    const options = await res.json(); // [{id, text}]
    const sel = document.getElementById('tresiduo');
    sel.innerHTML = '<option label="Escoja el Tipo de Residuo ..." disabled></option>';

    options.forEach(opt => {
      const o = document.createElement('option');
      o.value = opt.id;
      o.textContent = opt.text || '';
      if (selectedId && Number(selectedId) === Number(opt.id)) o.selected = true;
      sel.appendChild(o);
    });

    // Selecciona cabecera como disabled si no hay selectedId
    if (!selectedId) sel.selectedIndex = 0;
  } catch (e) {
    console.error('Error cargando tipos de residuo', e);
    alert('No se pudo cargar la lista de tipos de residuo.');
  }
}
</script>

<script>
    $(document).ready(function() {
        $('#btnSaveResiduos').on('click', function() {
            // Validar el formulario antes de enviar
            if ($('#residuoForm')[0].checkValidity()) {
                // Si es válido, enviar el formulario
                
                send_form('residuoForm');
                $('#btnDismiss').click(); // Cerrar el modal después de enviar
                
            } else {
                // Si no es válido, mostrar un mensaje de error
                alert("Por favor, completa todos los campos requeridos.");
            }
        });
    });
</script>